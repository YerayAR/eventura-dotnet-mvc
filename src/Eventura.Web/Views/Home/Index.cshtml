@using System.Globalization
@model IReadOnlyCollection<Eventura.Web.Models.EventListItemViewModel>
@{
    ViewData["Title"] = "Próximos eventos";
    var hasEvents = Model.Any();
    var seatsAvailable = Model.Sum(e => e.RemainingCapacity);
    var nextEvent = Model.OrderBy(e => e.StartDateTime).FirstOrDefault();
    var currentCulture = CultureInfo.CurrentUICulture;
}

<section class="hero">
    <div class="hero-content">
        <div>
            <span class="pill">Planifica experiencias memorables</span>
            <h1 class="hero-title">Descubre, organiza y comparte eventos increíbles</h1>
            <p class="hero-description">
                Centraliza la gestión de tu agenda, controla el aforo en tiempo real y ofrece una experiencia de reservas transparente.
                Eventura te acompaña desde la idea hasta la evaluación post-evento.
            </p>
            <div class="hero-actions">
                <a class="btn btn-primary" asp-controller="Events" asp-action="Index">
                    Explorar eventos
                </a>
                @if (User.IsInRole("Organizer") || User.IsInRole("Admin"))
                {
                    <a class="btn btn-outline" asp-controller="Events" asp-action="Create">
                        Crear nuevo evento
                    </a>
                }
                else if (!(User.Identity?.IsAuthenticated ?? false))
                {
                    <a class="btn btn-outline" asp-controller="Account" asp-action="Register">
                        Crear cuenta gratuita
                    </a>
                }
            </div>
        </div>
        <article class="content-card accent" aria-label="Resumen en vivo">
            <header class="section-heading" style="margin-bottom:1rem;">
                <h2 class="section-title" style="margin:0;">Radar de actividad</h2>
                <span class="chip primary">@Model.Count evento(s)</span>
            </header>
            <div class="metrics-grid">
                <div class="metric-card" role="status">
                    <span class="metric-label">Aforo disponible</span>
                    <span class="metric-value">@seatsAvailable</span>
                    <span class="section-subtitle">
                        Capacidad restante lista para reservar.
                    </span>
                </div>
                <div class="metric-card" role="status">
                    <span class="metric-label">Próximo arranque</span>
                    <span class="metric-value">
                        @(nextEvent is null
                            ? "Sin agenda"
                            : nextEvent.StartDateTime.LocalDateTime.ToString("ddd d MMM · HH:mm", currentCulture))
                    </span>
                    @if (nextEvent is { })
                    {
                        <span class="section-subtitle">
                            @nextEvent.City · @nextEvent.Category
                        </span>
                    }
                </div>
            </div>
        </article>
    </div>
</section>

<section class="container">
    <div class="section-heading">
        <div>
            <p class="pill">Próximos eventos</p>
            <h2 class="section-title">Agenda actualizada</h2>
            <p class="section-subtitle">Filtra por categoría, ciudad o busca por título para encontrar tu siguiente experiencia.</p>
        </div>
        <div class="filters" role="search">
            <label class="filter-group" for="event-search">
                <span>Buscar</span>
                <input id="event-search" type="search" placeholder="Título o ciudad" autocomplete="off" data-event-search />
            </label>
            <label class="filter-group" for="event-category">
                <span>Categoría</span>
                <select id="event-category" data-event-category>
                    <option value="all">Todas</option>
                    @foreach (var category in Enum.GetValues<Eventura.Domain.Enums.EventCategory>())
                    {
                        <option value="@category">@category</option>
                    }
                </select>
            </label>
        </div>
    </div>

    @if (!hasEvents)
    {
        <div class="empty-state" data-empty-state="true">
            <h2>No hay eventos disponibles por ahora</h2>
            <p>Activa las notificaciones por correo para recibir alertas cuando se publiquen nuevas actividades.</p>
            @if (User.IsInRole("Organizer") || User.IsInRole("Admin"))
            {
                <a class="btn btn-primary" asp-controller="Events" asp-action="Create">Crear el primer evento</a>
            }
            else
            {
                <a class="btn btn-outline" asp-controller="Events" asp-action="Index">Volver al catálogo</a>
            }
        </div>
    }
    else
    {
        <div class="card-grid" data-event-list>
            @foreach (var item in Model.OrderBy(e => e.StartDateTime))
            {
                var cardClasses = item.IsCancelled ? "card event-card is-disabled" : "card event-card";
                <article class="@cardClasses"
                         data-event-card
                         data-event-title="@item.Title.ToLowerInvariant()"
                         data-event-city="@item.City.ToLowerInvariant()"
                         data-event-category="@item.Category">
                    <header class="stack" style="gap:0.35rem;">
                        <div class="tags">
                            <span class="badge">@item.Category</span>
                            <span class="chip neutral">
                                @item.StartDateTime.LocalDateTime.ToString("dd MMM yyyy · HH:mm", currentCulture)
                            </span>
                        </div>
                        <h3>@item.Title</h3>
                    </header>
                    <p>@item.Description</p>
                    <dl class="card-meta">
                        <div>
                            <dt class="sr-only">Ubicación</dt>
                            <dd>@item.AddressLine, @item.City</dd>
                        </div>
                        <div>
                            <dt class="sr-only">Duración</dt>
                            <dd>@item.Duration.TotalHours.ToString("0.#", CultureInfo.InvariantCulture) h</dd>
                        </div>
                    </dl>
                    <div class="section-heading" style="margin:0;">
                        <p class="section-subtitle">
                            Capacidad restante
                        </p>
                        <span class="status @(item.RemainingCapacity > 0 ? "success" : "danger")">
                            <span aria-hidden="true">●</span>
                            @(item.RemainingCapacity > 0 ? $"{item.RemainingCapacity} lugares" : "Completo")
                        </span>
                    </div>
                    <div class="hero-actions" style="margin-top:1rem;">
                        <a class="btn btn-outline" asp-controller="Events" asp-action="Details" asp-route-id="@item.Id">
                            Ver detalles
                        </a>
                        @if (!item.IsCancelled && item.RemainingCapacity > 0 && (User.Identity?.IsAuthenticated ?? false))
                        {
                            <form asp-controller="Reservations" asp-action="Create" method="post" data-loading="true">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="EventId" value="@item.Id" />
                                <input type="hidden" name="Quantity" value="1" />
                                <button type="submit" class="btn btn-primary">Reservar cupo</button>
                            </form>
                        }
                        else if (item.IsCancelled)
                        {
                            <span class="chip warning">Evento cancelado</span>
                        }
                    </div>
                </article>
            }
        </div>
        <div class="empty-state" data-empty-state style="display:none;">
            <h2>Sin coincidencias</h2>
            <p>No encontramos eventos que coincidan con tu búsqueda actual. Ajusta los filtros o revisa la cartelera completa.</p>
        </div>
    }
</section>

@section Scripts {
    <script>
        window.Eventura = window.Eventura ?? {};
        window.Eventura.home = { filtersEnabled: true };
    </script>
}
